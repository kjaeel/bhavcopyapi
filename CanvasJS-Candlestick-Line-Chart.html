<!DOCTYPE HTML>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
<script src="app.js"></script>
<script src="user/controller.js"></script>
<script src="user/model.js"></script>
<script src="user/routes.js"></script>
<script src="user/service.js"></script>

<script>
window.onload = function () {
	function callapipost(){
		postApi().then(function(success){
			//document.getElementById("demo1").innerHTML= success.message;
			var chartData = success.message;
			var dateStr = chartData[0].expiry_dt.split('T')[0];
			var date = dateStr.split('-')
			var day = date[2];
			var month = date[1];
			var year = date[0];
			var monthToDb = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
			var showChart = [];
			var lineChart = [];
			var arrayY= [5450,5414,5520,5460,5450,5500]
			for(var i = 0; i < chartData.length ; i++ ){
				if(chartData[i].timestamp){
					timestamp = chartData[i].timestamp;
					showChart.push({ x: new Date(timestamp), y: [chartData[i].open, chartData[i].high, chartData[i].low, chartData[i].close] });
					lineChart.push({ x: new Date(timestamp), y: arrayY[i] });
				}
				
			}
			console.log(lineChart);

			var chart = new CanvasJS.Chart("chartContainer", {
				animationEnabled: true,
				theme: "light2", // "light1", "light2", "dark1", "dark2"
				exportEnabled: true,
				title:{
					text: chartData[0].symbol+"-"+day+"-"+monthToDb[month-1]+"-"+year
				},
				subtitles: [{
					text: "Vedant Margadarshak"
				}],
				axisX: {
					valueFormatString: "DD(DDD) MMM"
				},
				axisY: {
					includeZero:false, 
					prefix: "",
					title: ""
				},
				axisY2: {
					prefix: "",
					suffix: "",
					title: "",
					tickLength: 0
				},
				toolTip: {
					shared: true
				},
				legend: {
					reversed: true,
					cursor: "pointer",
					itemclick: toggleDataSeries
				},     
				data: [{
					type: "candlestick",
					showInLegend: true,
					name: "Stock Price",
					yValueFormatString: "₹#,##0.00",
					xValueFormatString: "DD(DDD) MMM",
					dataPoints: showChart
					/*[   // Y: [Open, High ,Low, Close]
						{ x: new Date(2016, 0), y: [101.949997, 112.839996, 89.370003, 112.209999] },
						{ x: new Date(2016, 1), y: [112.269997, 117.589996, 96.820000, 106.919998] },
						{ x: new Date(2016, 2), y: [107.830002, 116.989998, 104.400002, 114.099998] },
						{ x: new Date(2016, 3), y: [113.750000, 120.790001, 106.309998, 117.580002] },
						{ x: new Date(2016, 4), y: [117.830002, 121.080002, 115.879997, 118.809998] },
						{ x: new Date(2016, 5), y: [118.500000, 119.440002, 108.230003, 114.279999] },
						{ x: new Date(2016, 6), y: [114.199997, 128.330002, 112.970001, 123.940002] },
						{ x: new Date(2016, 7), y: [123.849998, 126.730003, 122.070000, 126.120003] },
						{ x: new Date(2016, 8), y: [126.379997, 131.979996, 125.599998, 128.270004] },
						{ x: new Date(2016, 9), y: [128.380005, 133.500000, 126.750000, 130.990005] },
						{ x: new Date(2016, 10), y: [131.410004, 131.940002, 113.550003, 118.419998] },
						{ x: new Date(2016, 11), y: [118.379997, 122.500000, 114.000000, 115.050003] }
					]*/
				},
				{
					type: "line",
					showInLegend: true,
					name: "avg 1",
					axisYType: "secondary",
					yValueFormatString: "₹#,##0.00",
					dataPoints: lineChart
				}]
			});
			chart.render();

			function toggleDataSeries(e) {
				if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
					e.dataSeries.visible = false;
				} else {
					e.dataSeries.visible = true;
				}
				e.chart.render();
			}
		},function(error){
			console.log(error);
			document.getElementById("demo1").innerHTML='error occured';
		});
	}

	function postApi(text) {
		return new Promise((resolve, reject)=>{
				const Url='http://localhost:3008/user/getChart';
				const data=getContracts();		
				
				$.post(Url, data, function(data,status){
				//console.log(data);
				console.log(status);
				}).done((response)=>{
					console.log(response);
					resolve(response);
				}).fail((error)=>{
					reject(error);
				});
		});
	}
	callapipost();
} 
</script>
</head>
<body>
<div id="chartContainer" style="height: 370px; max-width: 920px; margin: 0px auto;"></div>
<div id = "demo1">
</div>
<script type="text/javascript" src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
</body>
</html>